# Implementation Plan

## Scope Classification

- Classification: `Medium`
- Reasoning: Cross-cutting change spans Electron runtime, preload contract, build metadata, and CI release publishing.
- Workflow Depth:
  - `Medium` -> proposed design doc -> proposed-design-based runtime call stack -> runtime call stack review (minimum 3 rounds) -> implementation plan -> progress tracking

## Plan Maturity

- Current Status: `Ready For Implementation`
- Notes: Review gate revalidated in round 7 (`Implementation can start: Yes`).

## Preconditions (Must Be True Before Finalizing This Plan)

- Runtime call stack review artifact exists: `Yes`
- All in-scope use cases reviewed: `Yes`
- No unresolved blocking findings: `Yes`
- Minimum review rounds satisfied: `Yes` (`7/3`)
- Final gate decision in review artifact is `Implementation can start: Yes`: `Yes`

## Solution Sketch (Required For `Small`, Optional Otherwise)

- Use Cases In Scope: UC-001..UC-005 in proposed design.
- Touched Files/Modules: `electron/main.ts`, `electron/preload.ts`, `electron/types.d.ts`, `electron/appUpdater.ts`, `build/scripts/build.ts`, `.github/workflows/desktop-tag-build.yml`, `docs/electron_packaging.md`.
- API/Behavior Delta: add updater lifecycle + prompts + manual check bridge + release metadata upload rules.
- Key Assumptions: release repo remains `AutoByteus/autobyteus-desktop-releases`; updater metadata files are generated by electron-builder.
- Feed strategy assumption: updater reads builder-generated `app-update.yml` (publish config driven), not runtime `setFeedURL`.
- Known Risks: platform-specific updater behavior differences and release asset naming drift.

## Runtime Call Stack Review Gate (Required Before Implementation)

| Round | Use Case | Call Stack Location | Review Location | Naming Naturalness | File/API Naming Clarity | Business Flow Completeness | Structure & SoC Check | Unresolved Blocking Findings | Verdict |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | UC-001..UC-004 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Fail | Pass | Yes | Fail |
| 2 | UC-001..UC-004 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Fail | Pass | Yes | Fail |
| 3 (required for `Medium`) | UC-001..UC-004 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Pass | Pass | No | Pass |
| 4 | UC-001..UC-004 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Fail | Pass | Yes | Fail |
| 5 | UC-001..UC-004 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Pass | Pass | No | Pass |
| 6 | UC-001..UC-005 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Fail | Pass | Yes | Fail |
| 7 | UC-001..UC-005 | `tickets/desktop-auto-update-workflow/proposed-design-based-runtime-call-stack.md` | `tickets/desktop-auto-update-workflow/runtime-call-stack-review.md` | Pass | Pass | Pass | Pass | No | Pass |

## Go / No-Go Decision

- Decision: `Go`
- Evidence:
  - Review rounds completed: `7`
  - Final review round: `7`
  - Final review gate line (`Implementation can start`): `Yes`

## Principles

- Bottom-up: implement updater module first, then wiring, then build/release pipeline updates.
- Test-driven where practical for new module behavior.
- Mandatory modernization rule: no backward-compatibility shims or legacy branches.
- One file at a time unless blocked by cross-file contract dependencies.

## Dependency And Sequencing Map

| Order | File/Module | Depends On | Why This Order |
| --- | --- | --- | --- |
| 1 | `electron/appUpdater.ts` | N/A | Core update behavior should be isolated and testable first |
| 2 | `electron/main.ts` | `electron/appUpdater.ts` | Wire lifecycle and IPC after core module exists |
| 3 | `electron/preload.ts` | `electron/main.ts` IPC contract | Expose renderer bridge once handler exists |
| 4 | `electron/types.d.ts` | `electron/preload.ts` | Keep type contract in sync with exposed API |
| 5 | `build/scripts/build.ts` | N/A | Ensure update provider metadata generation is deterministic |
| 6 | `.github/workflows/desktop-tag-build.yml` | build outputs | Ensure release uploads contain metadata required by updater |
| 7 | `docs/electron_packaging.md` | implemented behavior | Sync docs to final runtime + release process |

## Design Delta Traceability (Required For `Medium/Large`)

| Change ID (from proposed design doc) | Change Type | Planned Task ID(s) | Includes Remove/Rename Work | Verification |
| --- | --- | --- | --- | --- |
| C-001 | Add | T-001 | No | Unit + Electron smoke |
| C-002 | Modify | T-002 | No | Electron smoke |
| C-003 | Modify | T-003 | No | Type-check + renderer invoke smoke |
| C-004 | Modify | T-004 | No | Build output inspection (`app-update.yml` + platform metadata) |
| C-005 | Modify | T-005 | No | Workflow artifact inspection (`.dmg`, `.zip`, `latest*.yml`, blockmaps) |
| C-007 | Modify | T-007 | No | Workflow signing-gate verification |
| C-006 | Modify | T-006 | No | Docs diff review |

## Decommission / Rename Execution Tasks

| Task ID | Item | Action (`Remove`/`Rename`/`Move`) | Cleanup Steps | Risk Notes |
| --- | --- | --- | --- | --- |
| T-DEL-001 | Legacy manual-only update expectation | `Remove` | Replace docs/flow guidance with updater-first path | Low |

## Step-By-Step Plan

1. Implement `electron/appUpdater.ts` with startup/interval checks and prompt handling.
2. Wire updater controller into `electron/main.ts` lifecycle and add `check-app-update` IPC handler.
3. Expose `checkAppUpdate` via preload bridge and types.
4. Update `build/scripts/build.ts` with publish provider defaults + env override configuration so `app-update.yml` is generated.
5. Update release workflow globs to upload binaries + metadata files (`.dmg`, `.zip`, `latest*.yml`, `*.blockmap`).
6. Add workflow signing gate checks so mac releases fail when signing prerequisites are missing.
7. Run targeted electron tests/type checks and one packaged smoke check.
8. Update `docs/electron_packaging.md` with update architecture and release requirements.

## Per-File Definition Of Done

| File | Implementation Done Criteria | Unit Test Criteria | Integration Test Criteria | Notes |
| --- | --- | --- | --- | --- |
| `electron/appUpdater.ts` | Handles update events + prompt logic + check scheduling | new updater module tests for decision branches | N/A | mock updater/dialog APIs |
| `electron/main.ts` | Initializes/disposes updater and handles manual check IPC | existing tests unchanged/new smoke if needed | Electron runtime smoke | no lifecycle regressions |
| `electron/preload.ts` | exposes `checkAppUpdate` | N/A | renderer->main invoke smoke | keep secure bridge pattern |
| `electron/types.d.ts` | typed API matches preload | type check passes | N/A | no `any` leakage |
| `build/scripts/build.ts` | publish provider config included and `app-update.yml` generated | N/A | build output includes metadata files | inspect `electron-dist` |
| `.github/workflows/desktop-tag-build.yml` | upload includes metadata, blockmaps, mac zip, and signing gate checks | N/A | workflow dry run/manual inspection | fail fast on missing artifacts and missing signing prerequisites |
| `docs/electron_packaging.md` | docs reflect new flow | N/A | N/A | concise operational guidance |

## Cross-Reference Exception Protocol

| File | Cross-Reference With | Why Unavoidable | Temporary Strategy | Unblock Condition | Design Follow-Up Status | Owner |
| --- | --- | --- | --- | --- | --- | --- |
| None expected | N/A | N/A | N/A | N/A | `Not Needed` | N/A |

## Design Feedback Loop

| Smell/Issue | Evidence (Files/Call Stack) | Design Section To Update | Action | Status |
| --- | --- | --- | --- | --- |
| None currently | N/A | N/A | N/A | Pending |

## Test Strategy

- Unit tests: new tests for updater decision logic and failure handling.
- Integration tests: Electron main-process smoke for IPC/manual trigger path.
- E2E feasibility: full signed-release auto-update E2E may be partially blocked in local env; if blocked, record reason and verify with packaged smoke + release asset inspection.
- Test data / fixtures: mock update events (`update-available`, `update-downloaded`, `error`) and dialog responses.
